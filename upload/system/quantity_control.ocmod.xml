<?xml version="1.0" encoding="UTF-8"?>
<modification>
<name>Quantity control</name>
<version>1.1</version>
<code>Quantity control</code>
<author>f4ber@f4ber.ru</author>

<file path="catalog/controller/product/*.php">
	<operation error="skip">
	<search><![CDATA[ $data['products'][] = array( ]]></search>
	<add position="after"><![CDATA[ 
	'quantity' => $result['quantity'],
	'minimum'	  => $result['minimum'],	
	]]></add>
	</operation>
</file>	
<file path="catalog/controller/module/latest.php">
	<operation error="skip">
	<search><![CDATA[ $data['products'][] = array( ]]></search>
	<add position="after"><![CDATA[ 
	'quantity' => $result['quantity'],
	'minimum'	  => $result['minimum'],	
	]]></add>
	</operation>
</file>
<file path="catalog/controller/module/special.php">
	<operation error="skip">
	<search><![CDATA[ $data['products'][] = array( ]]></search>
	<add position="after"><![CDATA[ 
	'quantity' => $result['quantity'],
	'minimum'	  => $result['minimum'],	
	]]></add>
	</operation>
</file>
<file path="catalog/controller/module/bestseller.php">
	<operation error="skip">
	<search><![CDATA[ $data['products'][] = array( ]]></search>
	<add position="after"><![CDATA[ 
	'quantity' => $result['quantity'],
	'minimum'	  => $result['minimum'],	
	]]></add>
	</operation>
</file>
<file path="catalog/controller/module/featured.php">
	<operation error="skip">
	<search><![CDATA[ $data['products'][] = array( ]]></search>
	<add position="after"><![CDATA[ 
	'quantity' => $product_info['quantity'],
	'minimum'	  => $product_info['minimum'],	
	]]></add>
	</operation>
</file>	
<file path="catalog/controller/product/product.php">
	<operation error="skip">
	<search><![CDATA[ $data['points'] = $product_info['points']; ]]></search>
	<add position="after"><![CDATA[ $data['quantity'] = $product_info['quantity']; ]]></add>
	</operation>
</file>	
<file path="catalog/view/theme/*/template/product/*.tpl">
	<operation error="skip">
	<search><![CDATA[ <div class="button-group"> ]]></search>
	<add position="before"><![CDATA[ 
	<div class="quantity_div">
	<span class="minus">&lt;</span>
	<input type="text" name="quantity" class="quantity_input" size="2" value="<?php if ($product['minimum']<1) { echo number_format($product['minimum'], 1, '.', ''); } else { echo number_format($product['minimum'], 0, '.', ''); } ?>" delta="<?php if ($product['minimum']<1) { echo "0.1"; } else { echo "1"; } ?>" data-maximum="<?php if ($product['minimum']<1) { echo number_format($product['quantity'], 1, '.', ''); } else { echo number_format($product['quantity'], 0, '.', ''); } ?>" />	  
	<span class="plus">&gt;</span>
	</div>
	]]></add>
	</operation>
	<operation>
	<search error="skip"><![CDATA[ onclick="cart.add('<?php echo $product['product_id']; ?>');" ]]></search>
	<add position="replace"><![CDATA[ onclick="cart.add('<?php echo $product['product_id']; ?>', $(this).parent().parent().find('.quantity_input').val());" ]]></add>
	</operation>
</file>
<file path="catalog/view/theme/*/template/module/latest.tpl">
	<operation error="skip">
	<search><![CDATA[ <div class="button-group"> ]]></search>
	<add position="before"><![CDATA[ 
	<div class="quantity_div">
	<span class="minus">&lt;</span>
	<input type="text" name="quantity" class="quantity_input" size="2" value="<?php if ($product['minimum']<1) { echo number_format($product['minimum'], 1, '.', ''); } else { echo number_format($product['minimum'], 0, '.', ''); } ?>" delta="<?php if ($product['minimum']<1) { echo "0.1"; } else { echo "1"; } ?>" data-maximum="<?php if ($product['minimum']<1) { echo number_format($product['quantity'], 1, '.', ''); } else { echo number_format($product['quantity'], 0, '.', ''); } ?>" />	  
	<span class="plus">&gt;</span>
	</div>
	]]></add>
	</operation>
	<operation>
	<search error="skip"><![CDATA[ onclick="cart.add('<?php echo $product['product_id']; ?>');" ]]></search>
	<add position="replace"><![CDATA[ onclick="cart.add('<?php echo $product['product_id']; ?>', $(this).parent().parent().find('.quantity_input').val());" ]]></add>
	</operation>
</file>
<file path="catalog/view/theme/*/template/module/special.tpl">
	<operation error="skip">
	<search><![CDATA[ <div class="button-group"> ]]></search>
	<add position="before"><![CDATA[ 
	<div class="quantity_div">
	<span class="minus">&lt;</span>
	<input type="text" name="quantity" class="quantity_input" size="2" value="<?php if ($product['minimum']<1) { echo number_format($product['minimum'], 1, '.', ''); } else { echo number_format($product['minimum'], 0, '.', ''); } ?>" delta="<?php if ($product['minimum']<1) { echo "0.1"; } else { echo "1"; } ?>" data-maximum="<?php if ($product['minimum']<1) { echo number_format($product['quantity'], 1, '.', ''); } else { echo number_format($product['quantity'], 0, '.', ''); } ?>" />	  
	<span class="plus">&gt;</span>
	</div>
	]]></add>
	</operation>
	<operation>
	<search error="skip"><![CDATA[ onclick="cart.add('<?php echo $product['product_id']; ?>');" ]]></search>
	<add position="replace"><![CDATA[ onclick="cart.add('<?php echo $product['product_id']; ?>', $(this).parent().parent().find('.quantity_input').val());" ]]></add>
	</operation>
</file>
<file path="catalog/view/theme/*/template/module/bestseller.tpl">
	<operation error="skip">
	<search><![CDATA[ <div class="button-group"> ]]></search>
	<add position="before"><![CDATA[ 
	<div class="quantity_div">
	<span class="minus">&lt;</span>
	<input type="text" name="quantity" class="quantity_input" size="2" value="<?php if ($product['minimum']<1) { echo number_format($product['minimum'], 1, '.', ''); } else { echo number_format($product['minimum'], 0, '.', ''); } ?>" delta="<?php if ($product['minimum']<1) { echo "0.1"; } else { echo "1"; } ?>" data-maximum="<?php if ($product['minimum']<1) { echo number_format($product['quantity'], 1, '.', ''); } else { echo number_format($product['quantity'], 0, '.', ''); } ?>" />	  
	<span class="plus">&gt;</span>
	</div>
	]]></add>
	</operation>
	<operation>
	<search error="skip"><![CDATA[ onclick="cart.add('<?php echo $product['product_id']; ?>');" ]]></search>
	<add position="replace"><![CDATA[ onclick="cart.add('<?php echo $product['product_id']; ?>', $(this).parent().parent().find('.quantity_input').val());" ]]></add>
	</operation>
</file>
<file path="catalog/view/theme/*/template/module/featured.tpl">
	<operation error="skip">
	<search><![CDATA[ <div class="button-group"> ]]></search>
	<add position="before"><![CDATA[ 
	<div class="quantity_div">
	<span class="minus">&lt;</span>
	<input type="text" name="quantity" class="quantity_input" size="2" value="<?php if ($product['minimum']<1) { echo number_format($product['minimum'], 1, '.', ''); } else { echo number_format($product['minimum'], 0, '.', ''); } ?>" delta="<?php if ($product['minimum']<1) { echo "0.1"; } else { echo "1"; } ?>" data-maximum="<?php if ($product['minimum']<1) { echo number_format($product['quantity'], 1, '.', ''); } else { echo number_format($product['quantity'], 0, '.', ''); } ?>" />	  
	<span class="plus">&gt;</span>
	</div>
	]]></add>
	</operation>
	<operation>
	<search error="skip"><![CDATA[ onclick="cart.add('<?php echo $product['product_id']; ?>');" ]]></search>
	<add position="replace"><![CDATA[ onclick="cart.add('<?php echo $product['product_id']; ?>', $(this).parent().parent().find('.quantity_input').val());" ]]></add>
	</operation>
</file>
<file path="catalog/view/theme/*/template/product/product.tpl">
	<operation error="skip">
	<search><![CDATA[ <input type="text" name="quantity" value="<?php echo $minimum; ?>" size="2" id="input-quantity" class="form-control" /> ]]></search>
	<add position="replace"><![CDATA[ 
	<div class="quantity_div">
	<span class="minus">&lt;</span>
	<input type="text" name="quantity" class="quantity_input" size="2" value="<?php if ($minimum<1) { echo number_format($minimum, 1, '.', ''); } else { echo number_format($minimum, 0, '.', ''); } ?>" delta="<?php if ($minimum<1) { echo "0.1"; } else { echo "1"; } ?>" data-maximum="<?php if ($minimum<1) { echo number_format($quantity, 1, '.', ''); } else { echo number_format($quantity, 0, '.', ''); } ?>" id="input-quantity" class="form-control" />	  
	<span class="plus">&gt;</span>
	</div>
	]]></add>
	</operation>
</file>
<file path="catalog/view/theme/*/template/common/footer.tpl">
	<operation error="skip">
	<search><![CDATA[ </body> ]]></search>
	<add position="before"><![CDATA[ 
	<script>
	function quantity_control() {
	$('.quantity_input').each(function() {
	var minimum = $(this).val();
	var maximum = $(this).attr('data-maximum');
	var delta = $(this).attr('delta');
	if(((maximum)*1000) <= 0) {
		$(this).val('0');
		$(this).parent().parent().find('.button-group').children().first().attr('disabled', 'disabled');
		if ($('.form-group').length !=0) {
			$(this).parent().parent().find('#button-cart').attr('disabled', 'disabled');
		}
		var text = 'данный товар закончился.';
	} else {
		var text = 'данного товара осталось всего ' + (((maximum)*1000)/1000) + ' шт(кг)!'
	}
	
	$(this).next().click(function () {
	if ((($(this).prev().val())*1000) <= (((maximum)*1000)-1)) {
		$(this).prev().val(((($(this).prev().val())*1000 + delta*1000)/1000));
	} else {
	if ($(this).parent().find('.stock_warning').length ==0) { $(this).parent().append($('<span class="stock_warning">На нашем складе ' + text + '</span>').fadeIn()); }
	$(this).parent().find('.stock_warning').fadeIn().delay('2000').fadeOut();
	}
	});
	$(this).prev().click(function () {
	if ((($(this).next().val())*1000) > (minimum)*1000) {
		$(this).next().val((($(this).next().val()*1000 - delta*1000)/1000));
	}
	});
	});
	}
	$(document).ready(function() {
		quantity_control();
	});
	</script>
	<style>
	.quantity_div {display:block; width:80px; height:26px; position:relative; padding:0; text-align:center; margin: 10px auto; line-height:normal !important;}
	.form-group .quantity_div {display:inline-block; vertical-align:middle;}
	.quantity_input {text-align:center; width:36px; height:24px !important; margin:0 -3px !important; border:solid 1px #d2d2d2 !important; border-radius:0 !important; box-shadow:inset 1px 1px 1px #ddd; background:#fff !important; color:#555 !important; font-family:Arial;}
	.plus, .minus {display:inline-block; vertical-align:top; height:24px !important; padding:3px 5px 3px !important; color:#888; border:solid 1px #d2d2d2; background:#eee; text-shadow:0 1px 0 #fff; box-shadow:inset 0 1px 0 #fff; font-size:14px; cursor:pointer; font-family:Arial;}
	.minus{border-radius:3px 0 0 3px; border-right:none;}
	.plus{border-radius:0 3px 3px 0; border-left:none;}
	.plus:hover, .minus:hover {background:#e5e5e5;}
	.stock_warning {position:absolute; z-index:999; left:-49px; bottom:35px; width:180px !important; padding:10px !important; background:#fefefe; background: linear-gradient(to bottom, #fefefe 0%, #f0f0f0 100%); box-shadow: 1px 1px 10px #ccc; line-height:15px; border:solid 1px #ddd; border-radius:10px; display:block; color:#f00 !important; font-size:12px;}
	</style>
	]]></add>
	</operation>
</file>
</modification>